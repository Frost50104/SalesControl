# SalesControl Audio System

–°–∏—Å—Ç–µ–º–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ –¥–ª—è —Ç–æ—á–µ–∫ –ø—Ä–æ–¥–∞–∂ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º –¥–æ–ø—Ä–æ–¥–∞–∂.

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Raspberry Pi (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

**–û–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å—ë:**

```bash
./auto_deploy.sh
```

üìñ –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: **[README_AUTO_DEPLOY.md](README_AUTO_DEPLOY.md)**

### –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤ (Core + ASR)

üìñ –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: **[DEPLOYMENT_TEST_GUIDE.md](DEPLOYMENT_TEST_GUIDE.md)**

üìä –°—Ç–∞—Ç—É—Å —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è: **[DEPLOYMENT_STATUS.md](DEPLOYMENT_STATUS.md)**

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è |
|-----------|----------|--------------|
| **recorder-agent** | –°–µ—Ä–≤–∏—Å –∑–∞–ø–∏—Å–∏ –Ω–∞ Raspberry Pi | [README –Ω–∏–∂–µ](#recorder-agent) |
| **ingest-api** | API –ø—Ä–∏—ë–º–∞ –∞—É–¥–∏–æ-—á–∞–Ω–∫–æ–≤ | [ingest_api/README.md](ingest_api/README.md) |
| **vad-worker** | VAD –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤ | [vad_worker/](vad_worker/) |
| **asr-worker** | –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ (Whisper) | [asr_worker/README.md](asr_worker/README.md) |
| **analysis-worker** | LLM-–∞–Ω–∞–ª–∏–∑ –¥–æ–ø—Ä–æ–¥–∞–∂ | [analysis_worker/](analysis_worker/) |
| **dashboard-web** | Web UI –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ | [dashboard_web/README.md](dashboard_web/README.md) |
| **infra** | Docker Compose –¥–ª—è –¥–µ–ø–ª–æ—è | [infra/](#–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞) |

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                              Raspberry Pi                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ USB Mic     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ recorder-    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ   outbox/    ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ (ALSA)      ‚îÇ     ‚îÇ agent        ‚îÇ     ‚îÇ  .ogg files  ‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ (ffmpeg)     ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îÇ                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ                          ‚îÇ
‚îÇ                                                  ‚îÇ HTTP POST                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           Core Server                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ ingest-api   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ  PostgreSQL  ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  vad-worker  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ (FastAPI)    ‚îÇ     ‚îÇ  (metadata)  ‚îÇ     ‚îÇ  (webrtcvad) ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ         ‚îÇ                    ‚îÇ                                              ‚îÇ
‚îÇ         ‚ñº                    ‚îÇ                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ  Tables: audio_chunks, dialogues,           ‚îÇ
‚îÇ  ‚îÇ File Storage ‚îÇ            ‚îÇ          speech_segments, dialogue_segments, ‚îÇ
‚îÇ  ‚îÇ (audio files)‚îÇ            ‚îÇ          dialogue_transcripts               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚îÇ PostgreSQL + HTTP (internal endpoint)
                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           ASR Server (–æ—Ç–¥–µ–ª—å–Ω—ã–π VPS)                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ                        asr-worker                                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ fetch ogg  ‚îÇ‚îÄ‚îÄ>‚îÇ assemble   ‚îÇ‚îÄ‚îÄ>‚îÇ transcribe ‚îÇ‚îÄ‚îÄ>‚îÇ   save     ‚îÇ   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ via HTTP   ‚îÇ   ‚îÇ audio      ‚îÇ   ‚îÇ (whisper)  ‚îÇ   ‚îÇ transcript ‚îÇ   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–µ—Ä–≤–µ—Ä (ingest-api)

```bash
cd infra
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env (–æ—Å–æ–±–µ–Ω–Ω–æ ADMIN_TOKEN!)

docker compose up -d
```

### 2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

```bash
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
POINT_ID=$(uuidgen)
REGISTER_ID=$(uuidgen)
DEVICE_ID=$(uuidgen)
DEVICE_TOKEN="$(openssl rand -hex 24)"

# –°–æ–∑–¥–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —á–µ—Ä–µ–∑ Admin API
curl -X POST http://your-server:8000/api/v1/admin/devices \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"point_id\": \"$POINT_ID\",
    \"register_id\": \"$REGISTER_ID\",
    \"device_id\": \"$DEVICE_ID\",
    \"token_plain\": \"$DEVICE_TOKEN\"
  }"

echo "Device Token: $DEVICE_TOKEN"
```

### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Raspberry Pi (recorder-agent)

```bash
# –ù–∞ Raspberry Pi
sudo apt install -y python3-venv ffmpeg alsa-utils

cd /opt
sudo mkdir -p recorder-agent && sudo chown $USER: recorder-agent
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞...

cd /opt/recorder-agent
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
pip install -e .

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
sudo mkdir -p /etc/recorder-agent
sudo nano /etc/recorder-agent/config.yaml
```

```yaml
# /etc/recorder-agent/config.yaml
identifiers:
  point_id: "<POINT_ID –∏–∑ —à–∞–≥–∞ 2>"
  register_id: "<REGISTER_ID –∏–∑ —à–∞–≥–∞ 2>"
  device_id: "<DEVICE_ID –∏–∑ —à–∞–≥–∞ 2>"

ingest:
  ingest_base_url: "http://your-server:8000"
  ingest_token: "<DEVICE_TOKEN –∏–∑ —à–∞–≥–∞ 2>"
```

```bash
# –ó–∞–ø—É—Å–∫
sudo systemctl enable --now recorder-agent
```

---

## –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### Docker Compose (infra/)

```bash
cd infra
cp .env.example .env
docker compose up -d
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
cd infra

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)
docker compose down

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (PostgreSQL, Redis, –∞—É–¥–∏–æ)
docker compose down -v
```

–°–µ—Ä–≤–∏—Å—ã:
- **ingest-api** ‚Äî FastAPI –Ω–∞ –ø–æ—Ä—Ç—É 8000
- **postgres** ‚Äî PostgreSQL 16
- **redis** ‚Äî Redis 7 (–¥–ª—è –æ—á–µ—Ä–µ–¥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏)
- **migrations** ‚Äî one-shot –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Alembic
- **vad-worker** ‚Äî VAD –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤
- **asr-worker** ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ (–º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º VPS)
- **analysis-worker** ‚Äî LLM-–∞–Ω–∞–ª–∏–∑ –¥–æ–ø—Ä–æ–¥–∞–∂ (—Ç—Ä–µ–±—É–µ—Ç OPENAI_API_KEY)
- **dashboard-web** ‚Äî Web UI –Ω–∞ –ø–æ—Ä—Ç—É 8080

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------------|----------|
| `ADMIN_TOKEN` | `changeme-admin-token` | –¢–æ–∫–µ–Ω –¥–ª—è Admin API |
| `INTERNAL_TOKEN` | *(–ø—É—Å—Ç–æ)* | –¢–æ–∫–µ–Ω –¥–ª—è internal API (asr-worker) |
| `POSTGRES_USER` | `ingest` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î |
| `POSTGRES_PASSWORD` | `ingest` | –ü–∞—Ä–æ–ª—å –ë–î |
| `AUDIO_STORAGE_PATH` | `./audio_storage` | –ü—É—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—É–¥–∏–æ |
| `OPENAI_API_KEY` | *(–ø—É—Å—Ç–æ)* | API –∫–ª—é—á OpenAI –¥–ª—è analysis-worker |
| `DASHBOARD_PORT` | `8080` | –ü–æ—Ä—Ç –¥–ª—è dashboard-web |

### Dashboard Web (UI –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)

Dashboard ‚Äî web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–æ–ø—Ä–æ–¥–∞–∂.

**–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:**

```bash
cd infra
docker compose up -d dashboard-web
```

**–û—Ç–∫—Ä—ã—Ç—å UI:** http://localhost:8080

**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080
2. –í–≤–µ–¥–∏—Ç–µ URL API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:8000`)
3. –í–≤–µ–¥–∏—Ç–µ ADMIN_TOKEN –∏–∑ –≤–∞—à–µ–≥–æ .env —Ñ–∞–π–ª–∞
4. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏"

–¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ sessionStorage –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –Ω–µ –≤–∫–ª—é—á—ë–Ω –≤ —Å–±–æ—Ä–∫—É.

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Dashboard:**
- **–û–±–∑–æ—Ä** ‚Äî —Å–≤–æ–¥–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∑–∞ –¥–µ–Ω—å: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤, –ø–æ–ø—ã—Ç–∫–∏ –¥–æ–ø—Ä–æ–¥–∞–∂, —Å—Ä–µ–¥–Ω–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- **–ì—Ä–∞—Ñ–∏–∫–∏** ‚Äî –¥–∏–Ω–∞–º–∏–∫–∞ –ø–æ —á–∞—Å–∞–º, —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞
- **–î–∏–∞–ª–æ–≥–∏** ‚Äî —Å–ø–∏—Å–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –¥–∞—Ç–µ, —Ç–æ—á–∫–µ, –ø–æ–ø—ã—Ç–∫–µ –¥–æ–ø—Ä–æ–¥–∞–∂–∏, –∫–∞—á–µ—Å—Ç–≤—É
- **–î–µ—Ç–∞–ª–∏** ‚Äî –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞, –∞–Ω–∞–ª–∏–∑ LLM, –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ü–∏—Ç–∞—Ç-–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤

**–¢–∞–π–º–∑–æ–Ω–∞:** Europe/Belgrade (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ UI –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)

### –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ ASR Worker –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º VPS

1. –ù–∞ core —Å–µ—Ä–≤–µ—Ä–µ –≤–∫–ª—é—á–∏—Ç–µ INTERNAL_TOKEN:
```bash
# infra/.env
INTERNAL_TOKEN=your-secret-internal-token
docker compose up -d ingest-api
```

2. –ù–∞ ASR VPS —Å–æ–∑–¥–∞–π—Ç–µ compose —Ñ–∞–π–ª:
```yaml
version: "3.9"
services:
  asr-worker:
    image: asr-worker:latest
    environment:
      - DATABASE_URL=postgresql+asyncpg://ingest:ingest@core-host:5432/ingest
      - INGEST_INTERNAL_BASE_URL=http://core-host:8000
      - INTERNAL_TOKEN=your-secret-internal-token
    volumes:
      - models:/models
volumes:
  models:
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```sql
SELECT dialogue_id, asr_status, asr_pass FROM dialogues WHERE asr_status = 'DONE';
SELECT dt.text FROM dialogue_transcripts dt LIMIT 5;
```

---

# recorder-agent

–°–µ—Ä–≤–∏—Å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ —Å USB-–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –¥–ª—è Raspberry Pi.
–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, –∫–æ–¥–∏—Ä—É–µ—Ç –≤ OGG/Opus, –Ω–∞—Ä–µ–∑–∞–µ—Ç —á–∞–Ω–∫–∞–º–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ Ingest API –ø–æ HTTPS.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ó–∞–ø–∏—Å—å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 08:00 ‚Äî 22:00, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∑–∞–ø–∏—Å—å —Å –Ω–∞—Ä–µ–∑–∫–æ–π –Ω–∞ —á–∞–Ω–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60 —Å–µ–∫)
- –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ OGG/Opus mono, –±–∏—Ç—Ä–µ–π—Ç 24/32 kbps (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- Offline-first: —á–∞–Ω–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
- –†–æ—Ç–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É (–¥–Ω–∏) –∏ –æ–±—ä—ë–º—É (–ì–ë), —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ FIFO
- –ê–≤—Ç–æ–¥–µ—Ç–µ–∫—Ç USB-–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
- systemd-—Å–µ—Ä–≤–∏—Å —Å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–º –∏ –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
- HTTP healthcheck –Ω–∞ localhost
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JSON-–ª–æ–≥–∏ (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å journalctl)

## –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Raspberry Pi OS (Debian Bookworm+) –∏–ª–∏ –ª—é–±–æ–π Linux —Å ALSA
- Python 3.11+
- ffmpeg —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π libopus
- USB-–º–∏–∫—Ä–æ—Ñ–æ–Ω

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
recorder_agent/
    __init__.py          ‚Äî –ø–∞–∫–µ—Ç, –≤–µ—Ä—Å–∏—è
    __main__.py          ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞: python -m recorder_agent
    config.py            ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (YAML + env)
    audio_device.py      ‚Äî –¥–µ—Ç–µ–∫—Ç ALSA-—É—Å—Ç—Ä–æ–π—Å—Ç–≤, –≤–∞–ª–∏–¥–∞—Ü–∏—è USB-–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    recorder.py          ‚Äî –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ ffmpeg segment muxer
    uploader.py          ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–∞–Ω–∫–æ–≤ –Ω–∞ Ingest API —Å retry
    spool.py             ‚Äî –æ—á–∏—Å—Ç–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∏ —Ä–∞–∑–º–µ—Ä—É
    scheduler.py         ‚Äî —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (HH:MM)
    healthcheck.py       ‚Äî HTTP /health endpoint
    logging_setup.py     ‚Äî JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ stderr
    main.py              ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Å–µ—Ä–≤–∏—Å–∞

tests/
    test_config.py       ‚Äî 7 —Ç–µ—Å—Ç–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    test_scheduler.py    ‚Äî 10 —Ç–µ—Å—Ç–æ–≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    test_spool.py        ‚Äî 6 —Ç–µ—Å—Ç–æ–≤ —Ä–æ—Ç–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    test_uploader.py     ‚Äî 11 —Ç–µ—Å—Ç–æ–≤ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–≥—Ä—É–∑–∫–∏

ingest_api/              ‚Äî —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—ë–º–∞ —á–∞–Ω–∫–æ–≤ (FastAPI)
infra/                   ‚Äî Docker Compose –¥–ª—è –¥–µ–ø–ª–æ—è —Å–µ—Ä–≤–µ—Ä–∞
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
sudo apt update
sudo apt install -y python3-venv ffmpeg alsa-utils
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∏–¥–µ–Ω

```bash
arecord -l
```

–í—ã–≤–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç—Ä–æ–∫—É –≤—Ä–æ–¥–µ:
```
card 1: Device [USB Audio Device], device 0: USB Audio [USB Audio]
```

### 3. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø—Ä–æ–µ–∫—Ç

```bash
cd /opt
sudo mkdir -p recorder-agent && sudo chown $USER: recorder-agent
cp -r /path/to/project/* /opt/recorder-agent/

cd /opt/recorder-agent
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
pip install -e .
```

### 4. –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

```bash
sudo mkdir -p /etc/recorder-agent
sudo cp config.yaml.example /etc/recorder-agent/config.yaml
sudo nano /etc/recorder-agent/config.yaml
```

–í –∫–æ–Ω—Ñ–∏–≥–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞—Ç—å:
- `point_id`, `register_id`, `device_id` ‚Äî –≤–∞–ª–∏–¥–Ω—ã–µ UUID
- `ingest_base_url` ‚Äî –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä `https://audio.example.com`)
- `ingest_token` ‚Äî Bearer-—Ç–æ–∫–µ–Ω –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `audio_device` ‚Äî ALSA-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä `hw:1,0`), –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–¥–µ—Ç–µ–∫—Ç–∞

### 5. –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```bash
sudo mkdir -p /var/lib/recorder-agent/spool
sudo useradd -r -s /usr/sbin/nologin recorder-agent || true
sudo usermod -aG audio recorder-agent
sudo chown -R recorder-agent: /var/lib/recorder-agent
```

## –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)

```bash
source /opt/recorder-agent/venv/bin/activate

# –° –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–æ–º
python -m recorder_agent -c /etc/recorder-agent/config.yaml

# –ß–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
export RA_POINT_ID="00000000-0000-0000-0000-000000000001"
export RA_REGISTER_ID="00000000-0000-0000-0000-000000000002"
export RA_DEVICE_ID="00000000-0000-0000-0000-000000000003"
export RA_INGEST_BASE_URL="https://audio.example.com"
export RA_INGEST_TOKEN="your-token"
python -m recorder_agent

# –° –æ—Ç–ª–∞–¥–æ—á–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
python -m recorder_agent -c /etc/recorder-agent/config.yaml --log-level DEBUG
```

## –ó–∞–ø—É—Å–∫ –∫–∞–∫ systemd-—Å–µ—Ä–≤–∏—Å

```bash
sudo cp recorder-agent.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable recorder-agent
sudo systemctl start recorder-agent
```

–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:
```bash
sudo systemctl status recorder-agent
sudo journalctl -u recorder-agent -f
```

## Healthcheck

```bash
curl -s http://127.0.0.1:8042/health | python3 -m json.tool
```

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:

```json
{
  "status": "ok",
  "recording": true,
  "in_schedule": true,
  "queue_size": 2,
  "uploaded_total": 147,
  "upload_errors_total": 3,
  "last_upload_ts": 1705312345.6,
  "spool_files": 42,
  "spool_bytes": 8372224,
  "point_id": "00000000-0000-0000-0000-000000000001"
}
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

```bash
# 1. –ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è
arecord -l

# 2. –†—É—á–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å (5 —Å–µ–∫)
arecord -D hw:1,0 -f S16_LE -r 48000 -c 1 -d 5 /tmp/test.wav
aplay /tmp/test.wav

# 3. –¢–µ—Å—Ç –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ ffmpeg
ffmpeg -f alsa -i hw:1,0 -ac 1 -ar 48000 -c:a libopus -b:a 24k -t 5 /tmp/test.ogg

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∏ –Ω–∞–±–ª—é–¥–∞—Ç—å –ª–æ–≥–∏
sudo systemctl start recorder-agent
sudo journalctl -u recorder-agent -f

# 5. –°–ª–µ–¥–∏—Ç—å –∑–∞ –ø–æ—è–≤–ª–µ–Ω–∏–µ–º —á–∞–Ω–∫–æ–≤ –≤ outbox
watch ls -la /var/lib/recorder-agent/spool/outbox/

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å healthcheck
curl -s http://127.0.0.1:8042/health | python3 -m json.tool

# 7. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ—á–µ—Ä–µ–¥—å —Ä–∞–∑–≥—Ä—É–∂–∞–µ—Ç—Å—è (queue_size —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è)
watch 'curl -s http://127.0.0.1:8042/health | python3 -m json.tool'
```

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
source /opt/recorder-agent/venv/bin/activate
pip install -e ".[dev]"
pytest -v
```

## –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

| –ö–ª—é—á | –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------------------|--------------|----------|
| `point_id` | `RA_POINT_ID` | *–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ* | UUID —Ç–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂ |
| `register_id` | `RA_REGISTER_ID` | *–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ* | UUID –∫–∞—Å—Å—ã |
| `device_id` | `RA_DEVICE_ID` | *–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ* | UUID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ |
| `ingest_base_url` | `RA_INGEST_BASE_URL` | *–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ* | –ë–∞–∑–æ–≤—ã–π URL Ingest API |
| `ingest_token` | `RA_INGEST_TOKEN` | *–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ* | Bearer-—Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ |
| `schedule_start` | `RA_SCHEDULE_START` | `08:00` | –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏ (HH:MM) |
| `schedule_end` | `RA_SCHEDULE_END` | `22:00` | –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ (HH:MM) |
| `chunk_seconds` | `RA_CHUNK_SECONDS` | `60` | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á–∞–Ω–∫–∞ (—Å–µ–∫—É–Ω–¥—ã) |
| `opus_bitrate_kbps` | `RA_OPUS_BITRATE_KBPS` | `24` | –ë–∏—Ç—Ä–µ–π—Ç Opus (kbps) |
| `audio_device` | `RA_AUDIO_DEVICE` | *(–∞–≤—Ç–æ–¥–µ—Ç–µ–∫—Ç)* | ALSA-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–Ω–∞–ø—Ä. `hw:1,0`) |
| `sample_rate` | `RA_SAMPLE_RATE` | `48000` | –ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ (–ì—Ü) |
| `spool_dir` | `RA_SPOOL_DIR` | `/var/lib/recorder-agent/spool` | –ö–æ—Ä–Ω–µ–≤–æ–π –∫–∞—Ç–∞–ª–æ–≥ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ |
| `max_spool_days` | `RA_MAX_SPOOL_DAYS` | `7` | –•—Ä–∞–Ω–∏—Ç—å –Ω–µ –¥–æ–ª—å—à–µ N –¥–Ω–µ–π |
| `max_spool_gb` | `RA_MAX_SPOOL_GB` | `20` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–ì–ë) |
| `retry_min_s` | `RA_RETRY_MIN_S` | `2` | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ retry (—Å–µ–∫) |
| `retry_max_s` | `RA_RETRY_MAX_S` | `300` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ retry (—Å–µ–∫) |
| `health_port` | `RA_HEALTH_PORT` | `8042` | –ü–æ—Ä—Ç HTTP healthcheck |

## –ü—Ä–æ—Ç–æ–∫–æ–ª –∑–∞–≥—Ä—É–∑–∫–∏

```
POST {ingest_base_url}/api/v1/chunks
Authorization: Bearer <token>
Content-Type: multipart/form-data

–ü–æ–ª—è: point_id, register_id, device_id, start_ts, end_ts, codec, sample_rate, channels
–§–∞–π–ª: chunk_file (audio/ogg)

–û—Ç–≤–µ—Ç 200: {"status": "ok", "chunk_id": "...", "stored_path": "...", "queued": true}
```

## –ü–æ—Ç–æ–∫–∏ (threads)

| –ü–æ—Ç–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|------------|
| **main** | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä, schedule loop: –∫–∞–∂–¥—ã–µ 5 —Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –∑–∞–ø—É—Å–∫–∞–µ—Ç/–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç recorder |
| **recorder** | –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–º ffmpeg, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ `.part` ‚Üí `.ogg`, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω |
| **uploader** | –°–∫–∞–Ω–∏—Ä—É–µ—Ç outbox, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–∞–Ω–∫–∏, backoff –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö |
| **spool-janitor** | –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ `max_spool_days` –∏ —Å–≤–µ—Ä—Ö `max_spool_gb` |
| **health** | HTTP-—Å–µ—Ä–≤–µ—Ä –Ω–∞ `127.0.0.1:health_port` |

## –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–±–æ–µ–≤

| –°–∏—Ç—É–∞—Ü–∏—è | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|----------|-----------|
| –ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á—ë–Ω | ffmpeg –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è, recorder –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å backoff 2 ‚Üí 4 ‚Üí 8 ‚Üí ... ‚Üí 60 —Å–µ–∫ |
| –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–µ—Ä–Ω—É–ª—Å—è | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏, backoff —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è |
| –°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ | –ß–∞–Ω–∫–∏ –∫–æ–ø—è—Ç—Å—è –≤ outbox, uploader —Ä–µ—Ç—Ä–∞–∏—Ç —Å backoff 2 ‚Üí 300 —Å–µ–∫ + jitter |
| –°–µ—Ç—å –≤–µ—Ä–Ω—É–ª–∞—Å—å | Backoff —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —É—Å–ø–µ—à–Ω–æ–º upload |
| –î–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω | SpoolJanitor —É–¥–∞–ª—è–µ—Ç —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã, –ø–æ–∫–∞ `total < max_spool_gb` |
| SIGTERM / SIGINT | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞: ffmpeg –ø–æ–ª—É—á–∞–µ—Ç SIGINT, —Ç–µ–∫—É—â–∏–π —á–∞–Ω–∫ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è, –ø–æ—Ç–æ–∫–∏ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è |
