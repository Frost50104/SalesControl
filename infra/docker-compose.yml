version: "3.9"

services:
  # ==========================================================================
  # Ingest API - Audio chunk ingestion service
  # ==========================================================================
  ingest-api:
    build:
      context: ../ingest_api
      dockerfile: Dockerfile
    container_name: ingest-api
    restart: unless-stopped
    ports:
      - "${INGEST_API_PORT:-8000}:8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-ingest}:${POSTGRES_PASSWORD:-ingest}@postgres:5432/${POSTGRES_DB:-ingest}
      - REDIS_URL=redis://redis:6379/0
      - AUDIO_STORAGE_DIR=/data/audio
      - ADMIN_TOKEN=${ADMIN_TOKEN:-changeme-admin-token}
      - INTERNAL_TOKEN=${INTERNAL_TOKEN:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAX_UPLOAD_SIZE_BYTES=${MAX_UPLOAD_SIZE_BYTES:-10485760}
    volumes:
      - audio_storage:/data/audio
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - salescontrol

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: ingest-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-ingest}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-ingest}
      - POSTGRES_DB=${POSTGRES_DB:-ingest}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ingest} -d ${POSTGRES_DB:-ingest}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - salescontrol

  # ==========================================================================
  # Redis - Queue and caching
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: ingest-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - salescontrol

  # ==========================================================================
  # Database Migrations (one-shot)
  # ==========================================================================
  migrations:
    build:
      context: ../ingest_api
      dockerfile: Dockerfile
    container_name: ingest-migrations
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-ingest}:${POSTGRES_PASSWORD:-ingest}@postgres:5432/${POSTGRES_DB:-ingest}
    command: ["python", "-m", "alembic", "upgrade", "head"]
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"
    networks:
      - salescontrol

  # ==========================================================================
  # VAD Worker - Voice Activity Detection and Dialogue Builder
  # ==========================================================================
  vad-worker:
    build:
      context: ../vad_worker
      dockerfile: Dockerfile
    container_name: vad-worker
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-ingest}:${POSTGRES_PASSWORD:-ingest}@postgres:5432/${POSTGRES_DB:-ingest}
      - AUDIO_STORAGE_DIR=/data/audio
      # VAD parameters
      - VAD_AGGRESSIVENESS=${VAD_AGGRESSIVENESS:-2}
      - VAD_FRAME_MS=${VAD_FRAME_MS:-30}
      # Dialogue building
      - SILENCE_GAP_SEC=${SILENCE_GAP_SEC:-12.0}
      - MAX_DIALOGUE_SEC=${MAX_DIALOGUE_SEC:-120.0}
      # Worker parameters (tuned for 50 devices)
      - POLL_INTERVAL_SEC=${POLL_INTERVAL_SEC:-5.0}
      - BATCH_SIZE=${BATCH_SIZE:-10}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - RETRY_DELAY_SEC=${RETRY_DELAY_SEC:-2.0}
      # Recovery & metrics
      - STUCK_TIMEOUT_SEC=${STUCK_TIMEOUT_SEC:-600}
      - RECOVERY_INTERVAL_SEC=${RECOVERY_INTERVAL_SEC:-60}
      - METRICS_LOG_INTERVAL_SEC=${METRICS_LOG_INTERVAL_SEC:-60}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - audio_storage:/data/audio:ro
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    networks:
      - salescontrol

  # ==========================================================================
  # ASR Worker - Speech Recognition (runs on separate VPS)
  # ==========================================================================
  # NOTE: This service is designed to run on a separate VPS with CPU resources.
  # It connects to the core PostgreSQL and fetches audio via HTTP from ingest-api.
  # Include this in your compose file on the ASR VPS, pointing to core services.
  asr-worker:
    build:
      context: ../asr_worker
      dockerfile: Dockerfile
    container_name: asr-worker
    restart: unless-stopped
    environment:
      # Database - connects to core PostgreSQL (use external host when running on separate VPS)
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-ingest}:${POSTGRES_PASSWORD:-ingest}@${ASR_DB_HOST:-postgres}:5432/${POSTGRES_DB:-ingest}
      # Ingest API internal endpoint (use external host when running on separate VPS)
      - INGEST_INTERNAL_BASE_URL=http://${ASR_INGEST_HOST:-ingest-api}:8000
      - INTERNAL_TOKEN=${INTERNAL_TOKEN}
      # Whisper settings
      - WHISPER_MODEL_FAST=${WHISPER_MODEL_FAST:-base}
      - WHISPER_MODEL_ACCURATE=${WHISPER_MODEL_ACCURATE:-small}
      - WHISPER_COMPUTE_TYPE=${WHISPER_COMPUTE_TYPE:-int8}
      - WHISPER_THREADS=${WHISPER_THREADS:-8}
      - WHISPER_CACHE_DIR=/models
      - BEAM_SIZE=${BEAM_SIZE:-5}
      - LANGUAGE=${WHISPER_LANGUAGE:-ru}
      # Heuristics
      - AVG_LOGPROB_THRESHOLD=${AVG_LOGPROB_THRESHOLD:--0.7}
      - MIN_TEXT_LENGTH_RATIO=${MIN_TEXT_LENGTH_RATIO:-0.5}
      - MIN_DURATION_FOR_ACCURATE=${MIN_DURATION_FOR_ACCURATE:-15.0}
      # Worker settings
      - POLL_INTERVAL_SEC=${ASR_POLL_INTERVAL_SEC:-5.0}
      - BATCH_SIZE=${ASR_BATCH_SIZE:-5}
      - ASR_STUCK_TIMEOUT_SEC=${ASR_STUCK_TIMEOUT_SEC:-600}
      - ASR_RECOVERY_INTERVAL_SEC=${ASR_RECOVERY_INTERVAL_SEC:-60}
      - METRICS_LOG_INTERVAL_SEC=${METRICS_LOG_INTERVAL_SEC:-60}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Temp storage
      - AUDIO_TMP_DIR=/tmp/asr_worker
    volumes:
      # Model cache - persist downloaded Whisper models
      - whisper_models:/models
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    networks:
      - salescontrol

  # ==========================================================================
  # Analysis Worker - LLM-based upsell analysis
  # ==========================================================================
  analysis-worker:
    build:
      context: ../analysis_worker
      dockerfile: Dockerfile
    container_name: analysis-worker
    restart: unless-stopped
    environment:
      # Database - connects to core PostgreSQL
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-ingest}:${POSTGRES_PASSWORD:-ingest}@postgres:5432/${POSTGRES_DB:-ingest}
      # OpenAI API settings
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_TIMEOUT_SEC=${OPENAI_TIMEOUT_SEC:-60.0}
      - OPENAI_MAX_RETRIES=${OPENAI_MAX_RETRIES:-3}
      # Prompt versioning
      - PROMPT_VERSION=${PROMPT_VERSION:-v1}
      # Prefilter settings
      - PREFILTER_ENABLED=${PREFILTER_ENABLED:-true}
      - PREFILTER_MIN_TEXT_LEN=${PREFILTER_MIN_TEXT_LEN:-10}
      - PREFILTER_MIN_DURATION_SEC=${PREFILTER_MIN_DURATION_SEC:-6.0}
      # Worker settings
      - POLL_INTERVAL_SEC=${ANALYSIS_POLL_INTERVAL_SEC:-5.0}
      - BATCH_SIZE=${ANALYSIS_BATCH_SIZE:-10}
      - ANALYSIS_STUCK_TIMEOUT_SEC=${ANALYSIS_STUCK_TIMEOUT_SEC:-600}
      - ANALYSIS_RECOVERY_INTERVAL_SEC=${ANALYSIS_RECOVERY_INTERVAL_SEC:-60}
      - METRICS_LOG_INTERVAL_SEC=${METRICS_LOG_INTERVAL_SEC:-60}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    networks:
      - salescontrol

  # ==========================================================================
  # Dashboard Web - Analytics UI
  # ==========================================================================
  dashboard-web:
    build:
      context: ../dashboard_web
      dockerfile: Dockerfile
    container_name: dashboard-web
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT:-8080}:80"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - salescontrol

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  whisper_models:
    driver: local
  audio_storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${AUDIO_STORAGE_PATH:-./audio_storage}

networks:
  salescontrol:
    driver: bridge
